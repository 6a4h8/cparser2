
    (?<sub>[(][?]<(?<square>\[?+)(?<name>\w++)(?(?{$+{square}})\])>(?{call "regbeginsub"})
    ([{]((?<entitlement>\w++),(??{dec "facet"})(?{call "recordappend"})(??{inc "facet"}))*+})?+(?&regex)[)]
    (?{call "regfinishsub"}))

    (?<group>[(](?<atomic>([?][>])?+)(?{call "regbegingroup"})(?&regex)[)](?{call "regfinish"}))

    (?<call>[(][?]
    (?<ampersand>(&(?<angular><)?+)?+)
    (?<callee>\w++)(?(?{$+{angular}})>)
    (?(?{$+{ampersand}})([(](?<arg>\w++)(??{dec "facet"})(?{call "recordappend"})(??{inc "facet"})
    (,(?<arg>\w++)(??{dec "facet"})(?{call "recordappend"})(??{inc "facet"}))*+[)])?+)(?{call "regcall"})[)](?<angular>))

    (?<lookaround>[(][?](?<sign>[!=])
    (?{call "regbeginlookaround"})(?&regex)[)](?{call "regfinish"}))

    (?<char>(?(?=(?<escapechar>\\))\\(?<char>[^g])(?{call "regchar"})|(?<escapechar>)(?<char>[^\[\]?*+{()}|])
    (?{call "regchar"})))

    (?<backreference>\\g[{](?<name>\w++)[}](?{call "regbackref"}))

    (?<escapetooptional>(-(?(?=\\)(?<escapeto>\\)(?<to>.)|(?<escapeto>)(?<to>[^]])))?+
    (??{dec "facet"})(?{call "recordappend"})(??{inc "facet"})(?<to>))

    (?<sequence>\[(?<not>\^?+)(?{call "regbeginseq"})
    (\\(?<escapechar>.)|(?<char>.))(?&escapetooptional)(?<escapechar>)
    ((?(?=\\)(?<escapechar>\\)(?<char>.)|(?<char>[^]]))(?&escapetooptional)(?<escapechar>))*+\]
    (?{call "regfinish"}))

    (?<conditional>[(][?](?(?=(?<lookaround>(?&lookaround)))
    \g{lookaround}(?<name>)(?{call "regbegincond"})
    |[(]<(?<name>\w++)>[)](?{call "regbegincond"}))(?&regex)[)]
    (?{call "regfinish"}))

    (?<verb>[(][*](?<verb>[A-Z]++)[)](?{call "regverb"}))

    (?<regexinner>(??{set {"savedcallouts" => []}})(??{inc "facet"})(?(?=(?<match>(?&conditional)))
    \g{match}|(?(?=(?<match>(?&lookaround)))
    \g{match}|(?(?=(?<match>(?&call)))
    \g{match}|(?(?=(?<match>(?&sub)))
    \g{match}|(?(?=(?<match>(?&verb)))
    \g{match}|(?(?=(?<match>(?&sequence)))
    \g{match}|(?(?=(?<match>(?&group)))
    \g{match}|(?(?=(?<match>(?&backreference)))
    \g{match}|(?(?=(?<match>(?&char)))
    \g{match}|(*F)
    )))))))))(??{dec "facet"})(?<quantifiers>([*+?][+?]?+)?+)(?{call "regendinner"}))

    (?<regexpart>(??{set {"savedcallouts" => []}})((?&regexinner)++|(?{call "regnothing"})))

    (?<regex>(?&regexpart)([|](?&regexpart)(?{call "regbranch"}))*+(?{call "regend"}))